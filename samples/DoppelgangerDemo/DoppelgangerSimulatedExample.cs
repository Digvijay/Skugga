using Xunit;
using Xunit.Abstractions;

namespace DoppelgangerDemo;

/// <summary>
/// âœ… THE SOLUTION DEMO: Shows how DoppelgÃ¤nger would work
/// 
/// Note: This demo simulates the DoppelgÃ¤nger workflow to showcase the concept.
/// In a real project with the OpenAPI Generator properly configured, these
/// interfaces would be auto-generated from your OpenAPI spec files.
/// </summary>
/// 
// Simulated V1 API interface (would be auto-generated by DoppelgÃ¤nger)
public interface IPaymentApiV1
{
    Payment GetPayment(string id);
    Payment CreatePayment(CreatePaymentRequest request);
}

// Simulated V2 API interface (would be auto-generated by DoppelgÃ¤nger)
public interface IPaymentApiV2
{
    Payment RetrievePayment(string id);  // Method renamed!
    Payment CreatePayment(CreatePaymentRequestV2 request);
}

public class Payment
{
    public string Id { get; set; } = "";
    public int Amount { get; set; }
    public string Status { get; set; } = "";
    public DateTime? CreatedAt { get; set; }
    public string? Description { get; set; }
}

public class CreatePaymentRequest
{
    public int Amount { get; set; }
    public string? Description { get; set; }
}

public class CreatePaymentRequestV2
{
    public decimal Amount { get; set; }  // Changed from int to decimal!
    public string Currency { get; set; } = "";  // New required field!
    public string? Description { get; set; }
}

public class DoppelgangerSimulatedExample
{
    private readonly ITestOutputHelper _output;

    public DoppelgangerSimulatedExample(ITestOutputHelper output)
    {
        _output = output;
    }

    [Fact]
    public void Demo_DoppelgangerWorkflow()
    {
        _output.WriteLine("ğŸ¯ DOPPELGÃ„NGER WORKFLOW DEMONSTRATION");
        _output.WriteLine("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        _output.WriteLine("");
        
        _output.WriteLine("ğŸ“– STEP 1: Add OpenAPI attribute to your interface");
        _output.WriteLine("   [SkuggaFromOpenApi(\"specs/payment-api-v1.json\")]");
        _output.WriteLine("   public partial interface IPaymentApi { }");
        _output.WriteLine("");
        
        _output.WriteLine("âœ¨ STEP 2: Build runs - DoppelgÃ¤nger auto-generates:");
        _output.WriteLine("   âœ“ Complete interface from OpenAPI spec");
        _output.WriteLine("   âœ“ All DTOs (Payment, CreatePaymentRequest, etc.)");
        _output.WriteLine("   âœ“ Mock implementation with realistic defaults");
        _output.WriteLine("   âœ“ Stateful behavior (optional)");
        _output.WriteLine("   âœ“ Auth mocking (optional)");
        _output.WriteLine("   âœ“ Schema validation (optional)");
        _output.WriteLine("");
        
        _output.WriteLine("ğŸ§ª STEP 3: Use the mock in your tests");
        _output.WriteLine("   var mock = Mock.Create<IPaymentApi>();");
        _output.WriteLine("   var payment = mock.GetPayment(\"pay_123\");");
        _output.WriteLine("");
        _output.WriteLine("   // Mock returns realistic data from spec:");
        _output.WriteLine("   Payment ID: pay_123");
        _output.WriteLine("   Amount: 9999 (cents)");
        _output.WriteLine("   Status: completed");
        _output.WriteLine("");
        
        _output.WriteLine("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        _output.WriteLine("");
        _output.WriteLine("ğŸ’¥ STEP 4: API Changes (V2 with breaking changes)");
        _output.WriteLine("   Payment Gateway team updates to V2:");
        _output.WriteLine("   - GetPayment â†’ RetrievePayment (renamed)");
        _output.WriteLine("   - amount: int â†’ decimal");
        _output.WriteLine("   - Added required: currency field");
        _output.WriteLine("");
        
        _output.WriteLine("ğŸ”„ STEP 5: Update your OpenAPI spec reference");
        _output.WriteLine("   [SkuggaFromOpenApi(\"specs/payment-api-v2.json\")]");
        _output.WriteLine("");
        
        _output.WriteLine("âŒ STEP 6: Build FAILS with clear errors");
        _output.WriteLine("   error CS0117: 'IPaymentApi' does not contain");
        _output.WriteLine("                  definition for 'GetPayment'");
        _output.WriteLine("   error CS0029: Cannot convert 'decimal' to 'int'");
        _output.WriteLine("   error: Property 'Currency' is required");
        _output.WriteLine("");
        
        _output.WriteLine("âœ… STEP 7: Fix your code BEFORE deploying!");
        _output.WriteLine("   var payment = mock.RetrievePayment(\"pay_123\");");
        _output.WriteLine("   decimal amount = payment.Amount;");
        _output.WriteLine("   string currency = payment.Currency;");
        _output.WriteLine("");
        
        _output.WriteLine("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        _output.WriteLine("");
        _output.WriteLine("ğŸ† RESULT: Production Saved!");
        _output.WriteLine("");
        _output.WriteLine("   Manual Mocks: Tests pass âœ“ â†’ Production crashes ğŸ’¥");
        _output.WriteLine("   DoppelgÃ¤nger: Build fails âŒ â†’ Fix before deploy âœ…");
    }

    [Fact]
    public void Demo_ComparisonTable()
    {
        _output.WriteLine("ğŸ“Š FEATURE COMPARISON");
        _output.WriteLine("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        _output.WriteLine("");
        
        _output.WriteLine("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”");
        _output.WriteLine("â”‚ Feature                    â”‚ Manual Mocks â”‚ DoppelgÃ¤nger     â”‚");
        _output.WriteLine("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤");
        _output.WriteLine("â”‚ Setup Time                 â”‚ 15+ minutes  â”‚ < 1 minute       â”‚");
        _output.WriteLine("â”‚ Code to Write              â”‚ 50+ lines    â”‚ 1 attribute      â”‚");
        _output.WriteLine("â”‚ Detects Contract Drift     â”‚ âŒ Never     â”‚ âœ… At build time â”‚");
        _output.WriteLine("â”‚ Contract Validation        â”‚ âŒ Manual    â”‚ âœ… Automatic     â”‚");
        _output.WriteLine("â”‚ Realistic Test Data        â”‚ âŒ You guess â”‚ âœ… From spec     â”‚");
        _output.WriteLine("â”‚ OAuth/JWT Mocking          â”‚ âŒ Manual    â”‚ âœ… Auto          â”‚");
        _output.WriteLine("â”‚ Stateful CRUD              â”‚ âŒ Code it   â”‚ âœ… Built-in      â”‚");
        _output.WriteLine("â”‚ Schema Validation          â”‚ âŒ No        â”‚ âœ… Runtime       â”‚");
        _output.WriteLine("â”‚ Native AOT Compatible      â”‚ âš ï¸  Maybe    â”‚ âœ… 100%          â”‚");
        _output.WriteLine("â”‚ Maintenance When API       â”‚ âŒ Rewrite   â”‚ âœ… Rebuild       â”‚");
        _output.WriteLine("â”‚   Changes                  â”‚    mocks     â”‚    automatically â”‚");
        _output.WriteLine("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜");
        _output.WriteLine("");
        
        _output.WriteLine("ğŸ’° ROI CALCULATION (Team of 5, 10 APIs):");
        _output.WriteLine("");
        _output.WriteLine("   Manual Mocks per year:");
        _output.WriteLine("   - Setup/maintenance: 30 hours Ã— $100/hr = $3,000");
        _output.WriteLine("   - Production incidents: 2-3 Ã— $10,000 = $20,000-30,000");
        _output.WriteLine("   - Total Cost: $23,000-33,000");
        _output.WriteLine("");
        _output.WriteLine("   DoppelgÃ¤nger per year:");
        _output.WriteLine("   - Setup: 10 minutes Ã— $100/hr = $17");
        _output.WriteLine("   - Maintenance: $0");
        _output.WriteLine("   - Production incidents: $0");
        _output.WriteLine("   - Total Cost: $17");
        _output.WriteLine("");
        _output.WriteLine("   ğŸ’µ ANNUAL SAVINGS: $23,000-33,000");
    }

    [Fact]
    public void Demo_UniqueValueProposition()
    {
        _output.WriteLine("ğŸŒŸ WHY DOPPELGÃ„NGER IS UNIQUE");
        _output.WriteLine("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        _output.WriteLine("");
        
        _output.WriteLine("ğŸ“¦ OpenAPI Generator:");
        _output.WriteLine("   âœ“ Generates production client SDKs");
        _output.WriteLine("   âœ“ Generates server stubs");
        _output.WriteLine("   âŒ Does NOT generate test mocks");
        _output.WriteLine("   âŒ Does NOT validate contracts in tests");
        _output.WriteLine("");
        
        _output.WriteLine("ğŸ“¦ NSwag:");
        _output.WriteLine("   âœ“ Generates C#/TypeScript clients");
        _output.WriteLine("   âœ“ Serves Swagger UI");
        _output.WriteLine("   âŒ Does NOT generate test mocks");
        _output.WriteLine("   âŒ Does NOT validate contracts in tests");
        _output.WriteLine("");
        
        _output.WriteLine("ğŸ“¦ Manual Mocks (Moq, NSubstitute):");
        _output.WriteLine("   âœ“ Great for unit testing");
        _output.WriteLine("   âŒ No OpenAPI integration");
        _output.WriteLine("   âŒ Manual interface definitions drift");
        _output.WriteLine("   âŒ Not Native AOT compatible");
        _output.WriteLine("");
        _output.WriteLine("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        _output.WriteLine("");
        _output.WriteLine("ğŸ¯ DOPPELGÃ„NGER:");
        _output.WriteLine("   âœ… Generates TEST MOCKS from OpenAPI");
        _output.WriteLine("   âœ… Build-time contract validation");
        _output.WriteLine("   âœ… Impossible to drift from API");
        _output.WriteLine("   âœ… Stateful CRUD behavior");
        _output.WriteLine("   âœ… Auth/security mocking");
        _output.WriteLine("   âœ… 100% Native AOT compatible");
        _output.WriteLine("");
        _output.WriteLine("   'The only tool that prevents contract drift");
        _output.WriteLine("    in your TESTS, not just your production code.'");
    }
}
